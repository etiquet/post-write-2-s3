


#commands to build and push docker image
#replace your-dockerhub-username with your dockerhub username
docker buildx create --use --platform=linux/arm64,linux/amd64 --name multi-platform-builder
docker buildx inspect --bootstrap
docker buildx build --platform=linux/arm64,linux/amd64 --push --tag etiquet/s3-upload-app:1.01 .

#user/create k8s cluster with nginx ingress controller

# recuperer le chart binami nginx > prendre le fichier values du repertoire ou bien surcharger le bitnami officiel avec le fichier values ( voir doc helm pour surcharger les valeurs)
#repertoire de travail (le votre sera different)

/Users/etiquet/Documents/GitHub/containers/bitnami/nginx

helm install my-nginx --debug ./nginx
helm upgrade my-nginx ./nginx

#note: le ingress est plus bas dans le fichier yaml
#repertoire de travail (le votre sera different)

cd /Users/etiquet/Documents/GitHub/post-write-2-s3

#commands to create k8s secret
#replace your-bucket-name, your-access-key, your-secret-key, your-region with your s3 bucket name, access key, secret key and region respectively
kubectl create secret generic s3-upload-app-secret --from-literal=S3_BUCKET=BBBBBB --from-literal=S3_ACCESS_KEY_ID=ZZZZZ --from-literal=S3_SECRET_ACCESS_KEY=XXXXXXXXXX --from-literal=S3_REGION=fr-par --from-literal=S3_URL=https://s3.fr-par.scw.cloud
kubectl apply -f deployment.yaml -f service.yaml -f ingress-ngx.yaml

#curl de test pour envoyer un fichier sur S3 via le docker image
curl -X POST -H "Content-Type: text/xml" -H "X-Myheader: myheadervalue"   -d "<?xml version=\"1.0\"?>" http://api-cncs.numerique-interieur.com/ODFClient

#curl de test pour envoyer un fichier sur S3 via le docker image
curl -X POST -H "Content-Type: text/xml" -H "X-Myheader: myheadervalue"   -d "<?xml version=\"1.0\"?>" http://192.168.210.59:5001/ODFClient


# pour tester comme ODF envoi les fichiers 
curl -X POST -H "Content-Type: application/xml; charset=UTF-8" -H "X-API-KEY: ZHpiwUuiffdectKeJG24cVudQi9VXlYI" -d '@example-file.xml' http://api-cncs.numerique-interieur.com/ODFClient

# pour teste avec mimetype bidon / inconnu > génére un fichier .rawbody
curl -X POST -H "Content-Type: application/toto; charset=UTF-8" -H "X-API-KEY: ZHpiwUuiffdectKeJG24cVudQi9VXlYI" -d '@example-file.xml' http://api-cncs.numerique-interieur.com/ODFClient

curl -H "X-Myheader: myheadervalue" http://api-cncs.numerique-interieur.com/health

curl -X POST -H "Content-Type: text/zozo" -H "X-Myheader: myheadervalue"   -d "<?xml version=\"1.0\"?>" http://192.168.210.59:5001/ODFClient